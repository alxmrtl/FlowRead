<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowRead - Train your eyes, guide your mind, flow through words</title>
    
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="FlowReadLogos/r-logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="FlowReadLogos/r-logo.png">
    <link rel="shortcut icon" href="FlowReadLogos/r-logo.png">
    
    <!-- iOS App Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="FlowReadLogos/r-logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="FlowReadLogos/r-logo.png">
    <link rel="apple-touch-icon" sizes="144x144" href="FlowReadLogos/r-logo.png">
    <link rel="apple-touch-icon" sizes="120x120" href="FlowReadLogos/r-logo.png">
    <link rel="apple-touch-icon" sizes="114x114" href="FlowReadLogos/r-logo.png">
    <link rel="apple-touch-icon" sizes="76x76" href="FlowReadLogos/r-logo.png">
    <link rel="apple-touch-icon" sizes="72x72" href="FlowReadLogos/r-logo.png">
    <link rel="apple-touch-icon" sizes="60x60" href="FlowReadLogos/r-logo.png">
    <link rel="apple-touch-icon" sizes="57x57" href="FlowReadLogos/r-logo.png">
    
    <!-- PWA Meta Tags for iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="FlowRead">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#517d63">
    <meta name="msapplication-TileColor" content="#517d63">
    <meta name="msapplication-TileImage" content="FlowReadLogos/r-logo.png">
    
    <!-- Preload critical images -->
    <link rel="preload" href="FlowReadLogos/flowread-text-logo.png" as="image">
    
    <link rel="stylesheet" href="styles.css">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <a href="#main" class="skip-link">Skip to main content</a>
    <div id="app">
        <header class="header">
            <div class="header-content">
                <div class="brand">
                    <img src="FlowReadLogos/flowread-text-logo.png" alt="FlowRead" class="logo-image" 
                         onload="this.classList.add('loaded')" 
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                    <div class="logo-fallback" style="display: none;">
                        <span class="logo-text">FlowRead</span>
                    </div>
                </div>
                
                <nav class="nav">
                    <button class="nav-btn active" data-mode="test">
                        <span class="nav-icon">●</span>
                        <span class="nav-label">Test</span>
                    </button>
                    <button class="nav-btn" data-mode="train">
                        <span class="nav-icon">△</span>
                        <span class="nav-label">Train</span>
                    </button>
                </nav>
            </div>
        </header>

        <main class="main" id="main">
            <!-- Test Screen (Merged Home/Assessment/Progress) -->
            <div class="screen active" id="test-screen">
                <!-- Compact Dashboard -->
                <div class="test-dashboard">
                    <div class="dashboard-stats">
                        <div class="dashboard-stat">
                            <div class="stat-label">Latest Test</div>
                            <div class="stat-value" id="latest-wpm">--</div>
                            <div class="stat-unit">WPM</div>
                        </div>
                        <div class="dashboard-stat">
                            <div class="stat-label">Best Test</div>
                            <div class="stat-value" id="best-wpm">--</div>
                            <div class="stat-unit">WPM</div>
                        </div>
                        <div class="dashboard-graph">
                            <div class="graph-label">Progress Over Time</div>
                            <canvas id="progress-mini-chart" width="200" height="60"></canvas>
                        </div>
                        
                        <!-- Test History inside Dashboard -->
                        <div class="dashboard-test-history collapsed">
                            <div class="panel-toggle" onclick="toggleTestHistory()" id="test-history-toggle">
                                <span>Test History</span>
                                <span class="toggle-arrow">▼</span>
                            </div>
                            <div class="instruction-card" id="test-history-content" style="display: none;">
                                <div class="history-header">
                                    <span class="history-col">Date</span>
                                    <span class="history-col">Speed</span>
                                    <span class="history-col">Actions</span>
                                </div>
                                <div class="history-list" id="test-history-list">
                                    <!-- Test history items will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Area -->
                <div class="test-area" id="test-area">
                    <!-- Test Instructions -->
                    <div class="test-instructions" id="test-instructions">
                        <div class="panel-toggle" onclick="toggleTestInstructions()">
                            <span>Instructions</span>
                            <span class="toggle-arrow">▼</span>
                        </div>
                        <div class="instruction-card">
                            <h3>▣ Reading Speed Test</h3>
                            <p>Read the passage below at your normal pace. We'll measure your speed and track your progress.</p>
                        </div>
                    </div>

                    <!-- Test Controls -->
                    <div class="test-controls">
                        <button id="begin-test" class="primary-btn">Begin Test</button>
                        <div class="test-timer" style="display: none;">
                            <span class="timer-label">Reading Time:</span>
                            <span class="timer" id="test-timer">0:00</span>
                        </div>
                        <button id="done-test" class="primary-btn" style="display: none;">Done</button>
                    </div>

                    <!-- Test Content -->
                    <div class="test-content" id="test-content"></div>
                </div>

                <!-- Test Results -->
                <div class="test-results" id="test-results" style="display: none;">
                    <div class="results-header">
                        <h3>◈ Your Reading Speed</h3>
                    </div>
                    
                    <div class="speed-display">
                        <div class="speed-number" id="result-wpm">250</div>
                        <div class="speed-unit">Words Per Minute</div>
                    </div>

                    <!-- WPM Scale -->
                    <div class="wpm-scale">
                        <div class="scale-track">
                            <div class="scale-marker" id="user-marker"></div>
                        </div>
                        <div class="scale-labels">
                            <span class="scale-label">0</span>
                            <span class="scale-label">150</span>
                            <span class="scale-label">300</span>
                            <span class="scale-label">500</span>
                            <span class="scale-label">750</span>
                            <span class="scale-label">1000</span>
                        </div>
                        <div class="scale-categories">
                            <div class="category beginner">◇ Reading Rookie</div>
                            <div class="category cruiser">◆ Text Cruiser</div>
                            <div class="category speedster">◈ Speed Demon</div>
                            <div class="category champion">◉ Reading Champion</div>
                            <div class="category legendary">★ Word Wizard</div>
                        </div>
                    </div>

                    <button id="complete-test" class="primary-btn">Complete</button>
                </div>
            </div>

            <!-- Train Screen -->
            <div class="screen" id="train-screen">
                <!-- Training Controls - Boxed Sections -->
                <div class="training-controls-container" id="training-controls-container">
                    <!-- MODE Section -->
                    <div class="control-box">
                        <h4 class="control-box-title">MODE</h4>
                        <div class="mode-buttons">
                            <button class="mode-btn active" data-mode="word-by-word" onclick="setTrainingMode('word-by-word')">
                                <span class="mode-icon">◈</span>
                                <span class="mode-label">Word</span>
                            </button>
                            <button class="mode-btn" data-mode="phrases" onclick="setTrainingMode('phrases')">
                                <span class="mode-icon">◆</span>
                                <span class="mode-label">Phrases</span>
                            </button>
                            <button class="mode-btn" data-mode="line-by-line" onclick="setTrainingMode('line-by-line')">
                                <span class="mode-icon">▣</span>
                                <span class="mode-label">Line</span>
                            </button>
                        </div>
                    </div>

                    <!-- TEXT Section -->
                    <div class="control-box">
                        <h4 class="control-box-title">TEXT</h4>
                        <div class="text-controls">
                            <button class="primary-btn compact-btn" id="choose-text-btn" onclick="showTextManagementDialog()">
                                ◐ Choose Text
                            </button>
                            <div class="current-text-display" id="current-text-display">
                                <span class="current-text-title">No text selected</span>
                                <span class="current-text-info">0 words</span>
                            </div>
                        </div>
                    </div>

                    <!-- STYLE Section -->
                    <div class="control-box">
                        <h4 class="control-box-title">STYLE</h4>
                        <div class="style-controls">
                            <div class="style-row">
                                <div class="size-control">
                                    <div class="value-badge">
                                        <span id="size-value">16</span>px
                                    </div>
                                    <div class="slider-group">
                                        <input type="range" id="text-size-slider" min="12" max="24" value="16" step="1">
                                    </div>
                                </div>
                            </div>
                            <div class="style-row">
                                <div class="font-toggle">
                                    <button class="font-btn active" data-font="serif" onclick="toggleFont('serif')">Serif</button>
                                    <button class="font-btn" data-font="sans" onclick="toggleFont('sans')">Sans</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Persistent Control Bar -->
                <div class="persistent-control-bar" id="persistent-control-bar">
                    <div class="control-bar-left">
                        <button id="start-training" class="primary-btn control-bar-btn">
                            <span class="btn-text">▶ Start</span>
                        </button>
                        <!-- These will be hidden initially and shown during training -->
                        <button id="pause-training" class="primary-btn control-bar-btn" style="display: none;">
                            <span class="btn-text">⏸</span>
                        </button>
                        <button id="stop-training" class="primary-btn control-bar-btn secondary" style="display: none;">
                            <span class="btn-text">⏹</span>
                        </button>
                    </div>
                    <div class="control-bar-right">
                        <div class="speed-control-bar">
                            <div class="speed-control-top">
                                <div class="value-badge">
                                    <span id="speed-value">250</span>
                                    <div class="wpm-label">WPM</div>
                                </div>
                                <div class="slider-group">
                                    <input type="range" id="training-speed-slider" min="100" max="800" value="250" step="10">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Training Display -->
                <div class="training-display">
                    <!-- Sticky Training Control Bar -->
                    <div class="training-control-bar" id="training-control-bar" style="display: none;">
                        <button class="control-bar-btn" id="bar-pause" title="Pause">‖ Pause</button>
                        <button class="control-bar-btn" id="bar-stop" title="Stop">■ Stop</button>
                    </div>
                    
                    <!-- Line-by-Line Training Area -->
                    <div class="text-content line-by-line-area" id="training-text">
                        <div class="line-pacer" id="line-pacer"></div>
                    </div>
                    
                    <!-- Word-by-Word Training Area -->
                    <div class="text-content word-by-word-area" id="word-training-text" style="display: none;">
                        <div class="word-display-container">
                            <div class="word-display" id="current-word"></div>
                            <div class="word-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="word-progress-fill"></div>
                                </div>
                                <div class="word-counter">
                                    <span id="current-word-index">0</span> / <span id="total-words">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Phrases Training Area -->
                    <div class="text-content word-by-word-area" id="phrases-training-text" style="display: none;">
                        <div class="word-display-container">
                            <div class="word-display" id="current-phrase"></div>
                            <div class="word-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="phrase-progress-fill"></div>
                                </div>
                                <div class="word-counter">
                                    <span id="current-phrase-index">0</span> / <span id="total-phrases">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Text Input Modal -->
            <div class="modal" id="text-input-modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h3>Add Your Text</h3>
                    <textarea id="custom-text" placeholder="Paste your text here..." rows="10"></textarea>
                    <div class="modal-controls">
                        <button class="secondary-btn" onclick="closeTextModal()">Cancel</button>
                        <button class="primary-btn" onclick="useCustomText()">Use This Text</button>
                    </div>
                </div>
            </div>

            <!-- Custom Training Text Modal -->
            <div class="modal" id="custom-training-text-modal">
                <div class="modal-content">
                    <span class="close" onclick="closeCustomTrainingTextDialog()">&times;</span>
                    <h3>◐ Add Custom Training Text</h3>
                    
                    <div class="modal-form">
                        <div class="form-group">
                            <label class="form-label">Title (optional)</label>
                            <input type="text" id="custom-text-title" placeholder="Enter a title for this text..." maxlength="50">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Text Content</label>
                            <textarea id="custom-training-text" placeholder="Paste your text here for training..." rows="10"></textarea>
                        </div>
                        
                        <div class="text-stats" id="custom-text-stats">
                            <span class="stat-item">Words: <span id="word-count">0</span></span>
                            <span class="stat-item">Estimated time: <span id="estimated-time">0 min</span></span>
                        </div>
                    </div>
                    
                    <div class="modal-controls">
                        <button class="secondary-btn" onclick="closeCustomTrainingTextDialog()">Cancel</button>
                        <button class="primary-btn" onclick="saveAndUseCustomText()">Save</button>
                    </div>
                </div>
            </div>

            <!-- Text Management Modal -->
            <div class="modal" id="text-management-modal">
                <div class="modal-content text-management-content">
                    <span class="close" onclick="closeTextManagementDialog()">&times;</span>
                    <h3>◐ Manage Training Texts</h3>
                    
                    <div class="text-management-layout">
                        <!-- Left Sidebar (1/4) -->
                        <div class="text-list-sidebar">
                            <button class="primary-btn new-text-btn" id="new-text-btn" onclick="createNewText()">
                                + New Text
                            </button>
                            <div class="saved-texts-list" id="saved-texts-list">
                                <!-- Saved texts will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Right Main Area (3/4) -->
                        <div class="text-editor-area">
                            <div class="text-editor-form" id="text-editor-form">
                                <div class="form-group">
                                    <label class="form-label">Title</label>
                                    <input type="text" id="text-editor-title" placeholder="Enter a title for this text..." maxlength="50">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Text Content</label>
                                    <textarea id="text-editor-content" placeholder="Paste your text here for training..." rows="12"></textarea>
                                </div>
                                
                                <div class="text-stats">
                                    <span class="stat-item">Words: <span id="text-editor-word-count">0</span></span>
                                    <span class="stat-item">Estimated time: <span id="text-editor-estimated-time">0 min</span></span>
                                </div>
                            </div>
                            
                            <div class="text-editor-empty" id="text-editor-empty" style="display: none;">
                                <p>Select a text from the left panel to edit, or create a new one.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-controls">
                        <button class="secondary-btn" id="delete-text-btn" onclick="deleteCurrentText()" style="display: none;">Delete</button>
                        <button class="secondary-btn" onclick="closeTextManagementDialog()">Close</button>
                        <button class="primary-btn" id="save-text-btn" onclick="saveCurrentText()" style="display: none;">Save & Use</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Settings Panel -->
        <div class="settings-panel" id="settings-panel">
            <div class="settings-content">
                <h3>Settings</h3>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="dyslexic-font"> Dyslexic-friendly font
                    </label>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="high-contrast"> High contrast mode
                    </label>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="motion-sensitive"> Reduce motion
                    </label>
                </div>
            </div>
        </div>

        <button class="settings-toggle" onclick="toggleSettings()">⚙️</button>
    </div>

    <script src="js/storage.js"></script>
    <script src="js/textprocessing.js"></script>
    <script src="js/comprehension.js"></script>
    <script src="js/drills.js"></script>
    <script src="js/reading.js"></script>
    <script src="js/progress.js"></script>
    <script src="js/assessment.js"></script>
    <script src="js/training.js"></script>
    <script src="js/test.js"></script>
    <script src="js/app.js"></script>
    
    <!-- PWA Status and Offline Indicators -->
    <div class="pwa-status">PWA Mode</div>
    <div class="offline-indicator" id="offline-indicator">
        📡 You're offline - FlowRead will continue working with cached data
    </div>

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('FlowRead SW: Registration successful with scope: ', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('FlowRead SW: Registration failed: ', error);
                    });
            });
        }
        
        // Check for PWA install prompt
        let deferredPrompt;
        const installButton = document.createElement('button');
        installButton.textContent = 'Install FlowRead';
        installButton.style.cssText = `
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--primary-color, #517d63);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(81, 125, 99, 0.3);
            z-index: 1000;
            display: none;
            transition: all 0.3s ease;
        `;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'block';
            document.body.appendChild(installButton);
        });
        
        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const result = await deferredPrompt.userChoice;
                console.log('PWA install result:', result);
                deferredPrompt = null;
                installButton.style.display = 'none';
            }
        });
        
        window.addEventListener('appinstalled', (evt) => {
            console.log('FlowRead PWA was installed');
            installButton.style.display = 'none';
        });
        
        // Offline/Online status handling
        const offlineIndicator = document.getElementById('offline-indicator');
        
        function updateOnlineStatus() {
            if (navigator.onLine) {
                offlineIndicator.classList.remove('show');
            } else {
                offlineIndicator.classList.add('show');
                setTimeout(() => {
                    offlineIndicator.classList.remove('show');
                }, 5000); // Hide after 5 seconds
            }
        }
        
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Check initial status
        if (!navigator.onLine) {
            offlineIndicator.classList.add('show');
        }
    </script>
</body>
</html>